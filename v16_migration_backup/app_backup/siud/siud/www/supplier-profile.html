{% extends "templates/web.html" %}

{% block title %}{{ title }}{% endblock %}

{% block page_content %}
<div class="supplier-profile-page" dir="rtl">
	<!-- Minimal Top Bar -->
	<div class="top-bar">
		<div class="container-fluid">
			<div class="d-flex justify-content-between align-items-center py-3">
				<a href="/supplier-dashboard" class="btn btn-sm btn-outline-primary">
					<svg class="icon-sm me-1" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<line x1="19" y1="12" x2="5" y2="12"></line>
						<polyline points="12 19 5 12 12 5"></polyline>
					</svg>
					חזרה לדף הבית
				</a>
				<div class="user-menu-wrapper">
					<button class="user-avatar-btn" id="userMenuBtn" title="{{ user_name }}">
						<div class="user-avatar">{{ user_initials }}</div>
					</button>
					<div class="user-menu-dropdown" id="userMenuDropdown">
						<div class="user-menu-header">
							<div class="user-menu-name">{{ user_name }}</div>
							<div class="user-menu-email">{{ user_email }}</div>
						</div>
						<div class="user-menu-divider"></div>
						<a href="/supplier-profile" class="user-menu-item active">
							<svg class="icon-sm" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
								<circle cx="12" cy="7" r="4"></circle>
							</svg>
							הפרופיל שלי
						</a>
						<a href="/api/method/logout" class="user-menu-item">
							<svg class="icon-sm" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
								<polyline points="16 17 21 12 16 7"></polyline>
								<line x1="21" y1="12" x2="9" y2="12"></line>
							</svg>
							התנתק
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>

<div class="container mt-4" dir="rtl">
	<!-- Page Title -->
	<div class="row mb-4">
		<div class="col-12">
			<h2 class="page-title">פרופיל הספק</h2>
			<p class="text-muted">עדכן את פרטי הספק שלך</p>
		</div>
	</div>

	<!-- Alert Messages -->
	<div class="row mt-3">
		<div class="col-12">
			<div id="alert-container"></div>
		</div>
	</div>

	<!-- Profile Form -->
	<div class="row mt-4">
		<div class="col-lg-8">
			<div class="card">
				<div class="card-body">
					<form id="supplier-profile-form">
						<!-- Supplier ID (Read-only) -->
						<div class="mb-3">
							<label for="supplier_id" class="form-label">מזהה ספק</label>
							<input type="text" class="form-control" id="supplier_id"
								value="{{ supplier.supplier_id }}" readonly disabled>
							<small class="form-text text-muted">מזהה הספק לא ניתן לשינוי</small>
						</div>

						<!-- Hidden field for supplier name (primary key) -->
						<input type="hidden" id="supplier_name_pk" value="{{ supplier.name }}">

						<!-- Supplier Name -->
						<div class="mb-3">
							<label for="supplier_name" class="form-label">שם הספק <span class="text-danger">*</span></label>
							<input type="text" class="form-control" id="supplier_name"
								value="{{ supplier.supplier_name }}" required>
						</div>

						<!-- Phone -->
						<div class="mb-3">
							<label for="phone" class="form-label">טלפון</label>
							<input type="tel" class="form-control" id="phone"
								value="{{ supplier.phone }}" placeholder="05X-XXXXXXX">
						</div>

						<!-- Email -->
						<div class="mb-3">
							<label for="email" class="form-label">כתובת דוא"ל</label>
							<input type="email" class="form-control" id="email"
								value="{{ supplier.email }}" placeholder="example@domain.com">
						</div>

						<!-- Address -->
						<div class="mb-3">
							<label for="address" class="form-label">כתובת</label>
							<textarea class="form-control" id="address" rows="3"
								placeholder="רחוב, מספר בית, עיר, מיקוד">{{ supplier.address }}</textarea>
						</div>

						<!-- Action Buttons -->
						<div class="mt-4">
							<button type="submit" class="btn btn-primary btn-lg" id="save-btn">
								<span id="save-btn-text">שמור שינויים</span>
								<span id="save-btn-spinner" class="spinner-border spinner-border-sm d-none" role="status">
									<span class="visually-hidden">שומר...</span>
								</span>
							</button>
							<a href="/supplier-dashboard" class="btn btn-outline-secondary btn-lg">
								חזור לדף הבית
							</a>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- Info Panel -->
		<div class="col-lg-4 mt-4 mt-lg-0">
			<div class="card bg-light">
				<div class="card-body">
					<h5 class="card-title">מידע</h5>
					<p class="card-text small">
						• שדות המסומנים ב-<span class="text-danger">*</span> הם שדות חובה<br>
						• מזהה הספק לא ניתן לשינוי<br>
						• פרטי הקשר ישמשו לתקשורת עם המערכת<br>
						• ודא שכתובת הדוא"ל פעילה ונכונה
					</p>
				</div>
			</div>
		</div>
	</div>
</div>
</div>

<style>
	/* Hide sidebar and footer */
	.web-sidebar,
	.sidebar,
	.page-sidebar,
	.web-footer,
	footer {
		display: none !important;
	}

	/* Make main content full width */
	.page-content-wrapper,
	.page-container {
		margin-left: 0 !important;
		margin-right: 0 !important;
		width: 100% !important;
	}

	/* Page wrapper */
	.supplier-profile-page {
		background: #f5f7fa;
		min-height: 100vh;
	}

	/* Minimal Top Bar */
	.top-bar {
		background: white;
		border-bottom: 1px solid #e5e7eb;
		position: sticky;
		top: 0;
		z-index: 100;
	}

	.page-title {
		font-size: 1.75rem;
		font-weight: 700;
		color: #111827;
		margin: 0;
	}

	/* User Menu Styles */
	.user-menu-wrapper {
		position: relative;
	}

	.user-avatar-btn {
		background: transparent;
		border: none;
		padding: 0;
		cursor: pointer;
		transition: transform 0.2s;
	}

	.user-avatar-btn:hover {
		transform: scale(1.05);
	}

	.user-avatar-btn.active {
		transform: scale(1.05);
	}

	.user-avatar {
		width: 44px;
		height: 44px;
		border-radius: 50%;
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		display: flex;
		align-items: center;
		justify-content: center;
		font-weight: 700;
		font-size: 0.938rem;
		border: 2px solid #e5e7eb;
		box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
		letter-spacing: 0.5px;
	}

	.user-menu-dropdown {
		position: absolute;
		top: calc(100% + 0.75rem);
		right: 0;
		background: white;
		border-radius: 12px;
		box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
		min-width: 240px;
		opacity: 0;
		visibility: hidden;
		transform: translateY(-10px);
		transition: all 0.2s;
		z-index: 1000;
	}

	.user-menu-dropdown.show {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
	}

	.user-menu-header {
		padding: 1rem;
		background: #f9fafb;
		border-radius: 12px 12px 0 0;
	}

	.user-menu-name {
		font-weight: 600;
		color: #111827;
		font-size: 0.938rem;
		margin-bottom: 0.25rem;
	}

	.user-menu-email {
		font-size: 0.813rem;
		color: #6b7280;
	}

	.user-menu-divider {
		height: 1px;
		background: #e5e7eb;
		margin: 0;
	}

	.user-menu-item {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		padding: 0.75rem 1rem;
		color: #374151;
		text-decoration: none;
		font-size: 0.875rem;
		font-weight: 500;
		transition: all 0.15s;
	}

	.user-menu-item:hover {
		background: #f3f4f6;
		color: #667eea;
	}

	.user-menu-item.active {
		background: #f3f4f6;
		color: #667eea;
	}

	.user-menu-item:last-child {
		border-radius: 0 0 12px 12px;
	}

	.user-menu-item svg {
		flex-shrink: 0;
	}

	.icon-sm {
		width: 16px;
		height: 16px;
	}

	.card {
		border-radius: 8px;
		box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	}

	.form-label {
		font-weight: 500;
		margin-bottom: 0.5rem;
	}

	.form-control:focus {
		border-color: #0d6efd;
		box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
	}

	.btn-lg {
		padding: 0.75rem 1.5rem;
	}

	#save-btn {
		min-width: 150px;
	}

	.spinner-border-sm {
		width: 1rem;
		height: 1rem;
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const form = document.getElementById('supplier-profile-form');
		const saveBtn = document.getElementById('save-btn');
		const saveBtnText = document.getElementById('save-btn-text');
		const saveBtnSpinner = document.getElementById('save-btn-spinner');
		const alertContainer = document.getElementById('alert-container');

		function showAlert(message, type = 'success') {
			const alertDiv = document.createElement('div');
			alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
			alertDiv.setAttribute('role', 'alert');
			alertDiv.innerHTML = `
				${message}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			`;
			alertContainer.innerHTML = '';
			alertContainer.appendChild(alertDiv);

			// Auto-dismiss after 5 seconds
			setTimeout(() => {
				alertDiv.classList.remove('show');
				setTimeout(() => alertDiv.remove(), 150);
			}, 5000);
		}

		form.addEventListener('submit', function(e) {
			e.preventDefault();

			// Disable button and show spinner
			saveBtn.disabled = true;
			saveBtnText.classList.add('d-none');
			saveBtnSpinner.classList.remove('d-none');

			// Get form data
			const formData = {
				name: document.getElementById('supplier_name_pk').value,
				supplier_name: document.getElementById('supplier_name').value,
				phone: document.getElementById('phone').value,
				email: document.getElementById('email').value,
				address: document.getElementById('address').value
			};

			// Call server-side function
			frappe.call({
				method: 'siud.www.supplier-profile.update_supplier_profile',
				args: formData,
				callback: function(response) {
					// Re-enable button
					saveBtn.disabled = false;
					saveBtnText.classList.remove('d-none');
					saveBtnSpinner.classList.add('d-none');

					if (response.message && response.message.success) {
						showAlert(response.message.message || 'הפרופיל עודכן בהצלחה!', 'success');
					} else {
						showAlert('אירעה שגיאה בעדכון הפרופיל. אנא נסה שוב.', 'danger');
					}
				},
				error: function(err) {
					// Re-enable button
					saveBtn.disabled = false;
					saveBtnText.classList.remove('d-none');
					saveBtnSpinner.classList.add('d-none');

					const errorMsg = err.message || 'אירעה שגיאה בעדכון הפרופיל. אנא נסה שוב.';
					showAlert(errorMsg, 'danger');
				}
			});
		});

		// User menu dropdown functionality
		const userMenuBtn = document.getElementById('userMenuBtn');
		const userMenuDropdown = document.getElementById('userMenuDropdown');

		if (userMenuBtn && userMenuDropdown) {
			// Toggle dropdown on button click
			userMenuBtn.addEventListener('click', function(e) {
				e.stopPropagation();
				userMenuBtn.classList.toggle('active');
				userMenuDropdown.classList.toggle('show');
			});

			// Close dropdown when clicking outside
			document.addEventListener('click', function(e) {
				if (!userMenuBtn.contains(e.target) && !userMenuDropdown.contains(e.target)) {
					userMenuBtn.classList.remove('active');
					userMenuDropdown.classList.remove('show');
				}
			});

			// Prevent dropdown from closing when clicking inside it
			userMenuDropdown.addEventListener('click', function(e) {
				e.stopPropagation();
			});
		}
	});
</script>
{% endblock %}
