זהו ניתוח מפורט של תהליך "הקמת ספק חדש במערכת" מתוך האפיון, המותאם לספציפיקציה טכנית הניתנת ליישום כ-Workflow ב-Frappe Framework.

Frappe Framework הוא פלטפורמת פיתוח מלאה (Full Stack) המאפשרת פיתוח יישומים עסקיים במהירות באמצעות ארכיטקטורת Low Code, והוא כולל תכונות מובנות כמו הרשאות, ממשקי משתמש ניתנים להגדרה, ומנגנוני Workflow. Workflow הוא אחד מהרכיבים המובנים ש-Frappe מספקת "מהקופסה".

### מפרט Workflow ב-Frappe: הקמת ספק חדש

#### 1. הגדרת DocType מרכזי (Entity)
ה-Workflow ייושם על DocType חדש שייצג בקשה להקמת ספק חדש. DocType הוא אבן הבניין הבסיסית של יישום Frappe, המייצגת טבלת בסיס נתונים, טופס, ומחלקה.

*   **שם DocType מוצע:** `Service Provider Application` (בקשת הקמת נותן שירות).
*   **שדות נדרשים ב-DocType:**
    *   `provider_name` (שם הספק)
    *   `service_type` (סוג שירות – לפי האפיון: טיפול בבית, מרכז יום, קהילה תומכת, מוצרי ספיגה)
    *   `branch_type` (סוג סניף הספק העתידי)
    *   `required_documents` (רשימת המסמכים הנדרשים כרשימת צ'קליסט או DocType ילד)
    *   `attached_documents` (קובץ מצורף עבור כל מסמך שהוגש)
    *   `rejection_reason` (סיבת דחייה – נדרש לצורך שליחת הודעה לספק)
    *   `hq_check_status` (סטטוס בדיקת מטה)
    *   `data_clarification_status` (סטטוס הבהרת נתונים)

#### 2. הגדרת תפקידים (Roles)
ה-Workflow דורש תפקידים כדי לקבוע מי רשאי לבצע מעברים בין הסטטוסים:

*   **`Service Provider User` (נותן שירות – חיצוני):** רשאי להתחיל את התהליך ולשלוח מסמכים (באמצעות פורטל ווב עצמאי ש-Frappe תומך בו).
*   **`Internal Reviewer` (בודק פנימי):** אחראי על בדיקת תקינות המסמכים הראשונית והכנה.
*   **`HQ Approver` (מאשר מטה):** אחראי על בדיקות המטה הסופיות ואישור ההסכם.

#### 3. הגדרת סטטוסי Workflow (States)
הסטטוסים מבוססים על שלבי התהליך המופיעים בתרשים ה-Workflow:

| שם הסטטוס (State Name) | תיאור | קוד (Code) |
| :--- | :--- | :--- |
| **טיוטה/הגשה ראשונית** | הספק שלח סט מסמכים (שלב התחלתי). | `Draft` |
| **בדיקת מטה** | בדיקת המסמכים הראשונית מול המטה. | `HQ_Check` |
| **בדיקת נתונים** | מעבר לבדיקת הנתונים והבהרת ביטוח לאומי. | `Data_Review` |
| **הכנת הסכם** | נותחון ספק חדש חסר, עובר להכנה שניה וקליטת מסמכים. | `Agreement_Prep` |
| **טיפול מטה סופי** | שיקוף ההסכם במערכת סיעוד וטיפול סופי במטה. | `Final_HQ_Processing` |
| **נדחה** | המסמך לא תקין, נשלחה הודעה לספק. | `Rejected` |
| **הסכם התקבל** | סיום מוצלח של התהליך. | `Approved` |

#### 4. הגדרת מעברים (Transitions)
המעברים מוגדרים לפי אירועים ופעולות שמתבצעות על ידי התפקידים השונים:

| כפתור/מעבר (Action) | סטטוס מ- (From State) | סטטוס ל- (To State) | תפקיד מאשר (Role) | תנאים/פעולות אוטומטיות |
| :--- | :--- | :--- | :--- | :--- |
| **הגשת מסמכים** | `Draft` | `HQ_Check` | `Service Provider User` | יצירת התראה על ספק חדש לגורם המטפל. |
| **תקין (אישור מטה)** | `HQ_Check` | `Data_Review` | `HQ Approver` | אם הבדיקה תקינה. |
| **לא תקין (דחייה מטה)** | `HQ_Check` | `Rejected` | `HQ Approver` | אם הבדיקה לא תקינה. |
| **תקין (אישור נתונים)** | `Data_Review` | `Agreement_Prep` | `Internal Reviewer` | אם הנתונים תקינים לאחר הבהרה. |
| **לא תקין (דחייה נתונים)** | `Data_Review` | `Rejected` | `Internal Reviewer` | אם הנתונים לא תקינים. |
| **קליטה תקינה** | `Agreement_Prep` | `Final_HQ_Processing` | `Internal Reviewer` | המסמכים נקלטו ועברו הכנה שנייה. |
| **קליטה לא תקינה**| `Agreement_Prep` | `Rejected` | `Internal Reviewer` | המסמכים חסרים או לא תקינים. |
| **סיום טיפול מטה** | `Final_HQ_Processing` | `Approved` | `HQ Approver` | שיקוף ההסכם במערכת סיעוד וטיפול מטה. |

#### 5. דרישות אוטומציה וטיפול בכישלון

Frappe תומך ביכולות אוטומציה חזקות (כגון Python Scripts ו-Email Alerts) שישמשו לניהול התקשורת וההתראות:

**א. התראות פנימיות וניהול משימות:**
1.  **התראה על הגשה:** כאשר סטטוס משתנה מ-`Draft` ל-`HQ_Check`, המערכת תייצר **התראה** לעובדים המוגדרים לכך, המציינת "התקבל מסמך חדש או פנייה חדשה מנותן שירותים".
2.  **מעקב המשך טיפול:** המערכת תאפשר מעקב אחר המשך טיפול של מחלקות אחרות (כספים/תקציבים/התקשרויות) לאחר שהחומר מועבר אליהם מסטטוס `Agreement_Prep` ל-`Final_HQ_Processing`.

**ב. תקשורת אוטומטית עם הספק (Email Alerts):**
יש לממש יכולת שליחת הודעות מייל אוטומטיות לספק:
1.  **אישור קבלה ותקינות ראשונית:** כאשר סטטוס משתנה ל-`Final_HQ_Processing` (מסמכים נבדקו ותקינים, והועברו לטיפול המשך).
2.  **דחייה (סטטוס `Rejected`):** כאשר המערכת מגיעה לסטטוס `Rejected` (לאחר בדיקת מטה או בדיקת נתונים/קליטה), יישלח מייל אוטומטי המודיע כי "מסמך לא תקין או מסמך חסר", עם פירוט הסיבה מתוך שדה `rejection_reason`.
3.  **סיום מוצלח:** כאשר סטטוס משתנה ל-`Approved`, יישלח מייל המודיע "שההסכם התקבל".

**ג. ניהול מסמכים:**
הספק נדרש להעלות קובץ חתום לאחר הורדת הנוסח העדכני. יש להשתמש בפיצ'ר ניהול הקבצים המובנה של Frappe כדי לשייך את המסמכים החתומים ל-DocType `Service Provider Application`. המערכת תאפשר לעקוב בצורה מסודרת אחר המסמכים שהוגשו ומה חסר.

***

כדי לסכם באמצעות מטפורה: אם Frappe Framework היא כמו אולר שוויצרי המכיל את כל הכלים הדרושים לבניית אפליקציה, הרי שהספציפיקציה הזו משתמשת בכלי ה-Workflow המובנה שלו כדי להבטיח שכל להב באולר (כל שלב בתהליך) יעבור בדיקה ואשרור מדויק על ידי הגורם המוסמך, לפני שהספק הופך להיות חלק אינטגרלי מהמנגנון.